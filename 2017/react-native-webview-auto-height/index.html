<!DOCTYPE html><html lang=zh-CN><head><meta name=generator content="Hexo 3.9.0"><meta charset=utf-8><meta name=X-UA-Compatible content="IE=edge"><title>ReactNative WebView 高度自适应网页 · Hexer</title><meta name=description content="ReactNative WebView 高度自适应网页 - Hexer"><meta name=viewport content="width=device-width, initial-scale=1"><link rel=icon href=https://i.loli.net/2018/12/05/5c07807cb76f9.png><link rel=stylesheet href=/css/apollo.css><link rel=search type=application/opensearchdescription+xml href=https://imrhj.cn/atom.xml title=Hexer></head><body><div class=wrap><header><a href="/" class=logo-link><img src=https://i.loli.net/2018/12/05/5c07807cb76f9.png alt=logo></a><ul class="nav nav-list"><li class=nav-list-item><a href="/" target=_self class=nav-list-link>BLOG</a></li><li class=nav-list-item><a href="/archives/" target=_self class=nav-list-link>ARCHIVE</a></li><li class=nav-list-item><a href="/about/" target=_self class=nav-list-link>ABOUT</a></li><li class=nav-list-item><a href=https://github.com/ahjsrhj target=_blank class=nav-list-link>GITHUB</a></li><li class=nav-list-item><a href="/friend/" target=_self class=nav-list-link>FRIEND</a></li></ul><script src=/js/canvas-nest-check.js></script></header><main class=container><div class=post><article class=post-block><h1 class=post-title>ReactNative WebView 高度自适应网页</h1><div class=post-info>2017年4月1日</div><div class=post-content><p><img src=https://i.loli.net/2019/06/14/5d035d4578e9031465.png></p><h1 id=0x01-前言><a href=#0x01-前言 class=headerlink title="0x01 前言"></a>0x01 前言</h1><p>在使用 <code>React Native</code> 的时候碰到一个需求，即将 <code>WebView</code> 与其他 <code>View</code> 进行混排，但是 <code>React Native</code> 本身并不像 <code>Android</code> 那样有类似 <code>wrap_content</code> 的属性进行高度控制，只能将高度写死。但是不同的页面高度肯定不一样的，这样就带来了一个问题: 怎么动态获取渲染后的网页高度并给 <code>WebView</code> 设置?</p><a id=more></a><h1 id=0x02-思路><a href=#0x02-思路 class=headerlink title="0x02 思路"></a>0x02 思路</h1><p>根据之前搞 <code>Android</code> 的 <code>WebView</code> 的经验来看，方法有两种:</p><ol><li>动态注入 js 代码来获取页面高度</li><li>找前端兄弟让他在页面里面提前嵌入 js 代码，我在展示时调用</li></ol><p>经过查阅文档以及求助于水稻哥，发现别人的方法基本上都是属于动态注入来进行工作的，依赖于以下两个 API</p><ol><li><p><a href=http://facebook.github.io/react-native/releases/0.42/docs/webview.html#injectedjavascript target=_blank rel=noopener>injectedJavaScript?: string</a></p><blockquote><p>Set this to provide JavaScript that will be injected into the web page when the view loads.</p></blockquote></li><li><p><a href=http://facebook.github.io/react-native/releases/0.42/docs/webview.html#onnavigationstatechange target=_blank rel=noopener>onNavigationStateChange?: function</a></p><blockquote><p>Function that is invoked when the <code>WebView</code> loading starts or ends.</p></blockquote></li></ol><p>第一个函数即是注入 js 代码的，第二个是用来接受回调的，接下来只要在回调函数里拿到页面的高度即可。而当使用 <code>injectedJavaScrpit</code> 方法进行 js 注入时，<code>onNavigationStateChange</code> 的回调函数会多一个参数 : <code>jsEvaluationValue</code>, 这个参数里面存放的是 js 执行的结果。</p><p>进行测试的代码如下：</p><figure class="highlight javascript"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br></pre></td><td class=code><pre><span class=line>&lt;WebView</span><br><span class=line>	source=&#123;&#123;<span class=attr>uri</span>: url&#125;&#125;</span><br><span class=line>	automaticallyAdjustContentInsets=&#123;<span class=literal>false</span>&#125;</span><br><span class=line>	scrollEnabled=&#123;<span class=literal>false</span>&#125;</span><br><span class=line>	injectedJavaScript=&#123;<span class=string>'888'</span>&#125;</span><br><span class=line>	onNavigationStateChange=&#123;(navState) =&gt; &#123;</span><br><span class=line>		<span class=built_in>console</span>.log(<span class=string>'- - - - - - rhjlog navState '</span> + <span class=built_in>JSON</span>.stringify(navState));</span><br><span class=line>&#125;&#125;</span><br></pre></td></tr></table></figure><p>打出来的 log 如下:</p><figure class="highlight verilog"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre></td><td class=code><pre><span class=line>- - - - - - rhjlog navState &#123;<span class=string>"target"</span>:<span class=number>90</span>,<span class=string>"canGoBack"</span>:false,<span class=string>"loading"</span>:false,<span class=string>"title"</span>:<span class=string>""</span>,<span class=string>"canGoForward"</span>:false,<span class=string>"navigationType"</span>:<span class=string>"other"</span>,<span class=string>"url"</span>:<span class=string>"https://h5.117sport.com/share/article.html?id=259"</span>&#125;</span><br><span class=line>- - - - - - rhjlog navState &#123;<span class=string>"target"</span>:<span class=number>90</span>,<span class=string>"canGoBack"</span>:false,<span class=string>"loading"</span>:false,<span class=string>"title"</span>:<span class=string>"蜂潮运动"</span>,<span class=string>"canGoForward"</span>:false,<span class=string>"jsEvaluationValue"</span>:<span class=string>"888"</span>,<span class=string>"url"</span>:<span class=string>"https://h5.117sport.com/share/article.html?id=259"</span>&#125;</span><br></pre></td></tr></table></figure><p>我仿佛看到了成功在向我招手，加上高度控制代码:</p><figure class="highlight javascript"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br></pre></td><td class=code><pre><span class=line><span class=class><span class=keyword>class</span> <span class=title>GoodsWebView</span> <span class=keyword>extends</span> <span class=title>BaseComp</span> </span>&#123;</span><br><span class=line>    <span class=keyword>constructor</span>(props) &#123;</span><br><span class=line>        <span class=keyword>super</span>(props)</span><br><span class=line>        <span class=keyword>this</span>.state= &#123;</span><br><span class=line>            height: <span class=number>100</span></span><br><span class=line>        &#125;</span><br><span class=line>    &#125;</span><br><span class=line>    render() &#123;</span><br><span class=line>        <span class=keyword>let</span> url = <span class=string>'https://h5.117sport.com/share/article.html?id=259'</span></span><br><span class=line>        <span class=keyword>return</span> (</span><br><span class=line>                &lt;WebView</span><br><span class=line>                    style=&#123;&#123;<span class=attr>height</span>: <span class=keyword>this</span>.state.height&#125;&#125;</span><br><span class=line>                    source=&#123;&#123;<span class=attr>uri</span>: url&#125;&#125;</span><br><span class=line>                    automaticallyAdjustContentInsets=&#123;<span class=literal>false</span>&#125;</span><br><span class=line>                    scrollEnabled=&#123;<span class=literal>false</span>&#125;</span><br><span class=line>                    injectedJavaScript=&#123;<span class=string>'document.body.clientHeight'</span>&#125;</span><br><span class=line>                    onNavigationStateChange=&#123;(navState) =&gt; &#123;</span><br><span class=line>                        <span class=keyword>let</span> height = <span class=built_in>parseInt</span>(navState.jsEvaluationValue)</span><br><span class=line>                        <span class=keyword>if</span> (height &gt; <span class=number>0</span>) &#123;</span><br><span class=line>                            <span class=keyword>this</span>.setState(&#123; height &#125;)</span><br><span class=line>                        &#125;</span><br><span class=line>                    &#125;&#125;</span><br><span class=line>                 /&gt;</span><br><span class=line>        )</span><br><span class=line>    &#125;</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><p>然而，随着继续搜索，发现许多人都表明在 <code>Android</code> 平台上，回调函数返回的结果没有 <code>jsEvaluationValue</code> 这个字段！！ （经过测试，确实木有..）并且公司的页面使用这种方法，有一定的失败的概率，好像与渲染时间有关？</p><p>那么就只能换一种思路了，查看一下 <code>onNavigationStateChange</code> 方法的回调，字段如下:</p><figure class="highlight json"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br></pre></td><td class=code><pre><span class=line>&#123;</span><br><span class=line>    <span class=attr>"canGoForward"</span>:<span class=literal>false</span>,</span><br><span class=line>    <span class=attr>"canGoBack"</span>:<span class=literal>false</span>,</span><br><span class=line>    <span class=attr>"loading"</span>:<span class=literal>false</span>,</span><br><span class=line>    <span class=attr>"title"</span>:<span class=string>""</span>,</span><br><span class=line>    <span class=attr>"url"</span>:<span class=string>"https://h5.117sport.com/share/article.html?id=259"</span>,</span><br><span class=line>    <span class=attr>"target"</span>:<span class=number>89</span></span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><p>这里 <code>title</code> 这个字段是用不到的，因此可以在 <code>js</code> 代码里将 <code>title</code> 设为高度，然后读取 <code>title</code></p></div></article></div></main><footer><div class=paginator><a href="/2017/esxi-for-samsung-noteboot/" class=prev>PREV</a><a href="/2016/use_sharedpreferences/" class=next>NEXT</a></div><script>var comments = 'true';
if (comments === 'true') {
    (function() {
        var vl = document.createElement('script');
        vl.src = '//cdn1.lncld.net/static/js/3.0.4/av-min.js';
        vl.async = true;
        (document.getElementsByTagName('head')[0] 
        || document.getElementsByTagName('body')[0]).appendChild(vl);
        var vl2 = document.createElement('script');
        vl2.src = '//unpkg.com/valine/dist/Valine.min.js';
        vl2.async = true;
        (document.getElementsByTagName('head')[0] 
        || document.getElementsByTagName('body')[0]).appendChild(vl2);
        var commitDiv = document.createElement('div');
        commitDiv.id='comment';
        document.getElementsByTagName('footer')[0].appendChild(commitDiv);
    })();
}</script><div class=copyright><p>© 2015 - 2021 <a href=https://imrhj.cn>Hexer</a>, <a href="http://beian.miit.gov.cn/" target=_blank>皖ICP备16006159号-1</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity=sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW crossorigin=anonymous></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-109294877-1",'auto');ga('send','pageview');</script><script>var comments = 'true';
if (comments === 'true') {
    (function() {
        let _tt = 20;
        let _tc = setInterval(() => {
            try {
                new Valine({
                    el: '#comment' ,
                    notify:false, 
                    verify:false, 
                    appId: 'lMIQlAfa6UoprWfiEDOceMSz-gzGzoHsz',
                    appKey: 'KiGYzc5UupBdbac67AJA54dJ',
                    placeholder: '来都来了，说点啥不 ٩(●˙▿˙●)۶…⋆ฺ',
                    path:window.location.pathname, 
                    avatar:'identicon',
                    guest_info: ['nick','link']
                });
                clearInterval(_tc)
            } catch(e) {
                _tt--;
                if (_tt < 1) {
                    clearInterval(_tc)
                }
            }
        }, 500)
    })();
}</script></body></html>