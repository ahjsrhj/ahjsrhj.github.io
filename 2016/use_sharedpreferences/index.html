<!DOCTYPE html><html lang=zh-CN><head><meta name=generator content="Hexo 3.9.0"><meta charset=utf-8><meta name=X-UA-Compatible content="IE=edge"><title>使用SharedPreferences遇到的一些问题 · Hexer</title><meta name=description content="使用SharedPreferences遇到的一些问题 - Hexer"><meta name=viewport content="width=device-width, initial-scale=1"><link rel=icon href=https://i.loli.net/2018/12/05/5c07807cb76f9.png><link rel=stylesheet href=/css/apollo.css><link rel=search type=application/opensearchdescription+xml href=https://imrhj.cn/atom.xml title=Hexer></head><body><div class=wrap><header><a href="/" class=logo-link><img src=https://i.loli.net/2018/12/05/5c07807cb76f9.png alt=logo></a><ul class="nav nav-list"><li class=nav-list-item><a href="/" target=_self class=nav-list-link>BLOG</a></li><li class=nav-list-item><a href="/archives/" target=_self class=nav-list-link>ARCHIVE</a></li><li class=nav-list-item><a href="/about/" target=_self class=nav-list-link>ABOUT</a></li><li class=nav-list-item><a href=https://github.com/ahjsrhj target=_blank class=nav-list-link>GITHUB</a></li><li class=nav-list-item><a href="/friend/" target=_self class=nav-list-link>FRIEND</a></li></ul><script src=/js/canvas-nest-check.js></script></header><main class=container><div class=post><article class=post-block><h1 class=post-title>使用SharedPreferences遇到的一些问题</h1><div class=post-info>2016年7月22日</div><div class=post-content><p><img src=https://i.loli.net/2019/06/14/5d0397d8e9d3d38898.png></p><h1 id=0x0-背景><a href=#0x0-背景 class=headerlink title="0x0 背景"></a>0x0 背景</h1><p>自从参加实习工作后，博客也没怎么更新了。。。（就是懒了）</p><a id=more></a><p>最近在空闲时间撸了一个 <strong>Xposed</strong> 模块，用来修改<strong>Pokémon GO</strong>的定位坐标的。这个模块的思路来源于<a href=http://drops.wooyun.org/tips/17840 target=_blank rel=noopener>这篇文章</a> ,因为乌云平台炸了，不知道何时恢复，因此可能暂时访问不了。这个模块有用户界面用于存储配置信息，但是在读取时使用 <strong>Xposed</strong> 自带的<code>XSharedPreferences</code>却出现读取不了的问题。今天写一记录一下在使用XSharedPreferences读取数据时遇到的坑点。</p><h1 id=0x1-过程><a href=#0x1-过程 class=headerlink title="0x1 过程"></a>0x1 过程</h1><p>最开始的时候我在写配置的时候使用的是<code>PreferenceManager.getDefaultSharedPreferences()</code>,在 <strong>Xposed</strong> 的<code>handleLoadPackage()</code>方法中hook本程序的<code>getApplicationContext()</code>方法去拿到 context,再使用<code>context.getSharedPreferences(BuildConfig.APPLICATION_ID, Context.MODE_WORLD_READABLE)</code>方法拿到<code>Preferences</code>，但是在使用它读取时无法读取到。而且这种方法即使可以也有个缺陷，就是每次使用前都要打开这个应用进行初始化，身为一个 xp 模块怎么能这么不中用呢！</p><p>转去 Google 发现，<code>XposedBridge</code>本身提供了一个类 : <strong>XSharedPreferences</strong>针对这种情况进行配置文件读取~</p><p>好咧，开工写代码 <code>XSharedPreferences preferences = new XSharedPreferences(BuildConfig.APPLICATION_ID);</code> 然而。。。。</p><p>仍然获取不到数据。。。</p><p>继续翻文档，我发现好像忽略了点什么，点开<code>getDefaultSharedPreferences()</code>方法的源码得知，它最后调用了<code>getSharedPreferences(name, Content.MODE_PRIVATE)</code>这个方法，也就是说生成的文件是私有的，而 Xposed 模块里的代码是hook 到 Andrioid 虚拟机那里，在目标 app 打开时调用的，所以<code>MODE_PRIVATE</code>肯定不能读取到，应该改为<code>MODE_WORLD_READABLE</code>。</p><p>OK,继续尝试，界面上的 Preferences 获取方法改成了<code>preferences = getSharedPreferences(BuildConfig.APPLICATION_ID, Context.MODE_WORLD_READABLE)</code>，再次运行，还是不行！！！</p><p>WTF！！！</p><p><code>adb shell</code> ，cd 到安装目录找到配置文件，文件名称是<code>包名.xml</code>，运行目标程序之后，当前目录下又多了个<code>包名_prefs.xml</code>文件。。</p><center><img src=https://i.loli.net/2019/06/14/5d0397fe1ece313070.png alt=2016-07-25_2016548158703.jpg></center><h1 id=0x2-总结><a href=#0x2-总结 class=headerlink title="0x2 总结"></a>0x2 总结</h1><p>所以说，原因就是两边的文件名不同。</p><ul><li><p>PACKAGE_NAME_prefs.xml:</p><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre></td><td class=code><pre><span class=line>PreferenceManager.getDefaultSharedPreferences(context);</span><br><span class=line>XSharedPreferences(PACKAGE_NAME);</span><br></pre></td></tr></table></figure></li><li><p>name.xml:</p><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre></td><td class=code><pre><span class=line>context.getSharedPreferences(name, MODE);</span><br><span class=line>XSharedPreferences(PACKAGE_NAME, name);</span><br></pre></td></tr></table></figure></li></ul><p>以上~</p></div></article></div></main><footer><div class=paginator><a href="/2017/react-native-webview-auto-height/" class=prev>PREV</a><a href="/2016/set-layer-type-make-view-redraw/" class=next>NEXT</a></div><script>var comments = 'true';
if (comments === 'true') {
    (function() {
        var vl = document.createElement('script');
        vl.src = '//cdn1.lncld.net/static/js/3.0.4/av-min.js';
        vl.async = true;
        (document.getElementsByTagName('head')[0] 
        || document.getElementsByTagName('body')[0]).appendChild(vl);
        var vl2 = document.createElement('script');
        vl2.src = '//unpkg.com/valine/dist/Valine.min.js';
        vl2.async = true;
        (document.getElementsByTagName('head')[0] 
        || document.getElementsByTagName('body')[0]).appendChild(vl2);
        var commitDiv = document.createElement('div');
        commitDiv.id='comment';
        document.getElementsByTagName('footer')[0].appendChild(commitDiv);
    })();
}</script><div class=copyright><p>© 2015 - 2021 <a href=https://imrhj.cn>Hexer</a>, <a href="http://beian.miit.gov.cn/" target=_blank>皖ICP备16006159号-1</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity=sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW crossorigin=anonymous></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-109294877-1",'auto');ga('send','pageview');</script><script>var comments = 'true';
if (comments === 'true') {
    (function() {
        let _tt = 20;
        let _tc = setInterval(() => {
            try {
                new Valine({
                    el: '#comment' ,
                    notify:false, 
                    verify:false, 
                    appId: 'lMIQlAfa6UoprWfiEDOceMSz-gzGzoHsz',
                    appKey: 'KiGYzc5UupBdbac67AJA54dJ',
                    placeholder: '来都来了，说点啥不 ٩(●˙▿˙●)۶…⋆ฺ',
                    path:window.location.pathname, 
                    avatar:'identicon',
                    guest_info: ['nick','link']
                });
                clearInterval(_tc)
            } catch(e) {
                _tt--;
                if (_tt < 1) {
                    clearInterval(_tc)
                }
            }
        }, 500)
    })();
}</script></body></html>