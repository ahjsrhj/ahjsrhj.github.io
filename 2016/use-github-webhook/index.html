<!DOCTYPE html><html lang=zh-CN><head><meta name=generator content="Hexo 3.9.0"><meta charset=utf-8><meta name=X-UA-Compatible content="IE=edge"><title>将网站转到vps上做镜像存储 · Hexer</title><meta name=description content="将网站转到vps上做镜像存储 - Hexer"><meta name=viewport content="width=device-width, initial-scale=1"><link rel=icon href=https://i.loli.net/2018/12/05/5c07807cb76f9.png><link rel=stylesheet href=/css/apollo.css><link rel=search type=application/opensearchdescription+xml href=https://imrhj.cn/atom.xml title=Hexer></head><body><div class=wrap><header><a href="/" class=logo-link><img src=https://i.loli.net/2018/12/05/5c07807cb76f9.png alt=logo></a><ul class="nav nav-list"><li class=nav-list-item><a href="/" target=_self class=nav-list-link>BLOG</a></li><li class=nav-list-item><a href="/archives/" target=_self class=nav-list-link>ARCHIVE</a></li><li class=nav-list-item><a href="/about/" target=_self class=nav-list-link>ABOUT</a></li><li class=nav-list-item><a href=https://github.com/ahjsrhj target=_blank class=nav-list-link>GITHUB</a></li><li class=nav-list-item><a href="/friend/" target=_self class=nav-list-link>FRIEND</a></li></ul><script src=/js/canvas-nest-check.js></script></header><main class=container><div class=post><article class=post-block><h1 class=post-title>将网站转到vps上做镜像存储</h1><div class=post-info>2016年4月9日</div><div class=post-content><p><img src=https://i.loli.net/2019/06/14/5d03981e83eea35252.png alt=1560516636183.png></p><blockquote><p>由于Github Page这两天间歇性抽风，因此打算将Hexo在我的腾讯云服务器上做一份镜像存储。考虑到每次更新博文都要手动传上去太麻烦，最开始打算使用Travis CI在自动部署的时候同时向我的VPS上传输一份文件镜像，但是这样的话需要使用ftps,Travis CI上还要为私匙加密。折腾起来太麻烦。</p></blockquote><a id=more></a><blockquote><p>google一番发现了<a href="https://developer.github.com/webhooks/" target=_blank rel=noopener>Github Webhook</a>，我可以设定当每次执行gitpush的时候，github向指定服务器发送请求，然后我在服务器端监听这个请求，来判断如果push来自master分支，那么就在服务器端调用<code>git fetch origin master</code>来进行更新服务器端代码，以此实现镜像存储的自动部署。</p></blockquote><h1 id=1-在github上设置webhook><a href=#1-在github上设置webhook class=headerlink title="1. 在github上设置webhook"></a>1. 在github上设置webhook</h1><p>打开你的项目，选择Settings-&gt;Webhooks &amp; services-&gt;Add webhook，在这个页面添加一个webhook。如图所示。<br><img src=https://i.loli.net/2019/06/14/5d0398441874465489.png></p><ul><li><strong>Payload URL</strong>: 在此输入服务器地址，比如我的是<a href=http://imrhj.tk:7777 target=_blank rel=noopener>http://imrhj.tk:7777</a></li><li><strong>Content type</strong>: 这一项保持默认不要动，因为我们接下来要用到<code>github-webhook-handler</code>去监听Gtihub发送到服务器上的请求，而<code>github-webhook-handler</code>智能解析json数据。<del>当然如果你要自己实现服务端监听的话，当我没说</del></li><li><strong>Secret</strong>: 密匙信息，建议输入一段随机字符串。用来进行身份鉴别，防止别人恶意向你的服务器发送请求。在接下来服务器端要用到。</li></ul><p>点击<strong>Update webhook</strong>即可添加。添加完成后Github会发送一条请求检测配置是否成功，因为服务器端还未配置，所以请求会失败。接下来配置完服务器端刷新即可。</p><h1 id=2-服务器端配置><a href=#2-服务器端配置 class=headerlink title="2. 服务器端配置"></a>2. 服务器端配置</h1><p>在这里如果不想<del>其实是懒</del>自己撸一个轮子，可以使用<a href=https://github.com/rvagg/github-webhook-handler target=_blank rel=noopener>github-webhook-handler</a>来进行服务端的处理。<br><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><span class=line>$ npm install -g github-webhook-handler</span><br></pre></td></tr></table></figure></p><p>接下来是监听程序listener.js <em>这里就用到了刚刚设置的Secret</em></p><figure class="highlight js"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br></pre></td><td class=code><pre><span class=line><span class=keyword>var</span> http = <span class=built_in>require</span>(<span class=string>'http'</span>)</span><br><span class=line><span class=keyword>var</span> createHandler = <span class=built_in>require</span>(<span class=string>'github-webhook-handler'</span>)</span><br><span class=line><span class=keyword>var</span> handler = createHandler(&#123; <span class=attr>path</span>: <span class=string>'/'</span>, <span class=attr>secret</span>: <span class=string>'我刚刚设置的secret'</span> &#125;)</span><br><span class=line></span><br><span class=line><span class=function><span class=keyword>function</span> <span class=title>run_cmd</span>(<span class=params>cmd, args, callback</span>) </span>&#123;</span><br><span class=line>  <span class=keyword>var</span> spawn = <span class=built_in>require</span>(<span class=string>'child_process'</span>).spawn;</span><br><span class=line>  <span class=keyword>var</span> child = spawn(cmd, args);</span><br><span class=line>  <span class=keyword>var</span> resp = <span class=string>""</span>;</span><br><span class=line></span><br><span class=line>  child.stdout.on(<span class=string>'data'</span>, <span class=function><span class=keyword>function</span>(<span class=params>buffer</span>) </span>&#123; resp += buffer.toString(); &#125;);</span><br><span class=line>  child.stdout.on(<span class=string>'end'</span>, <span class=function><span class=keyword>function</span>(<span class=params></span>) </span>&#123; callback (resp) &#125;);</span><br><span class=line>&#125;</span><br><span class=line></span><br><span class=line>http.createServer(<span class=function><span class=keyword>function</span> (<span class=params>req, res</span>) </span>&#123;</span><br><span class=line>  handler(req, res, <span class=function><span class=keyword>function</span> (<span class=params>err</span>) </span>&#123;</span><br><span class=line>    res.statusCode = <span class=number>404</span></span><br><span class=line>    res.end(<span class=string>'no such location'</span>)</span><br><span class=line>  &#125;)</span><br><span class=line>&#125;).listen(<span class=number>7777</span>)</span><br><span class=line></span><br><span class=line>handler.on(<span class=string>'error'</span>, <span class=function><span class=keyword>function</span> (<span class=params>err</span>) </span>&#123;</span><br><span class=line>  <span class=built_in>console</span>.error(<span class=string>'Error:'</span>, err.message);</span><br><span class=line>&#125;)</span><br><span class=line></span><br><span class=line>handler.on(<span class=string>'push'</span>, <span class=function><span class=keyword>function</span> (<span class=params>event</span>) </span>&#123;</span><br><span class=line>  <span class=built_in>console</span>.log(<span class=string>'Received a push event for %s to %s'</span>,</span><br><span class=line>    event.payload.repository.name,</span><br><span class=line>    event.payload.ref);</span><br><span class=line>  <span class=keyword>if</span> (event.payload.ref == <span class=string>'refs/heads/master'</span>) &#123;</span><br><span class=line>    run_cmd(<span class=string>'sh'</span>, [<span class=string>'./git.sh'</span>], <span class=function><span class=keyword>function</span>(<span class=params>text</span>)</span>&#123; <span class=built_in>console</span>.log(text) &#125;);</span><br><span class=line>  &#125;</span><br><span class=line>&#125;)</span><br></pre></td></tr></table></figure><p>在这里当收到github发送来的请求，检测头里包含的信息是否为<code>refs/heads/master</code>，匹配上之后，执行同目录下的<code>git.sh</code>更新网站信息。<br>下面是<code>git.sh</code>:<br><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre></td><td class=code><pre><span class=line><span class=built_in>cd</span> /usr/share/nginx/html</span><br><span class=line>git fetch origin master</span><br><span class=line>git reset --hard origin/master</span><br></pre></td></tr></table></figure></p><p>enjoy it~</p></div></article></div></main><footer><div class=paginator><a href="/2016/Retrofit2-learn/" class=prev>PREV</a><a href="/2016/open-os-x-ntfs/" class=next>NEXT</a></div><script>var comments = 'true';
if (comments === 'true') {
    (function() {
        var vl = document.createElement('script');
        vl.src = '//cdn1.lncld.net/static/js/3.0.4/av-min.js';
        vl.async = true;
        (document.getElementsByTagName('head')[0] 
        || document.getElementsByTagName('body')[0]).appendChild(vl);
        var vl2 = document.createElement('script');
        vl2.src = '//unpkg.com/valine/dist/Valine.min.js';
        vl2.async = true;
        (document.getElementsByTagName('head')[0] 
        || document.getElementsByTagName('body')[0]).appendChild(vl2);
        var commitDiv = document.createElement('div');
        commitDiv.id='comment';
        document.getElementsByTagName('footer')[0].appendChild(commitDiv);
    })();
}</script><div class=copyright><p>© 2015 - 2021 <a href=https://imrhj.cn>Hexer</a>, <a href="http://beian.miit.gov.cn/" target=_blank>皖ICP备16006159号-1</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity=sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW crossorigin=anonymous></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-109294877-1",'auto');ga('send','pageview');</script><script>var comments = 'true';
if (comments === 'true') {
    (function() {
        let _tt = 20;
        let _tc = setInterval(() => {
            try {
                new Valine({
                    el: '#comment' ,
                    notify:false, 
                    verify:false, 
                    appId: 'lMIQlAfa6UoprWfiEDOceMSz-gzGzoHsz',
                    appKey: 'KiGYzc5UupBdbac67AJA54dJ',
                    placeholder: '来都来了，说点啥不 ٩(●˙▿˙●)۶…⋆ฺ',
                    path:window.location.pathname, 
                    avatar:'identicon',
                    guest_info: ['nick','link']
                });
                clearInterval(_tc)
            } catch(e) {
                _tt--;
                if (_tt < 1) {
                    clearInterval(_tc)
                }
            }
        }, 500)
    })();
}</script></body></html>