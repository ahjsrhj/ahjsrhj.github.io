<!DOCTYPE html><html lang=zh-CN><head><meta name=generator content="Hexo 3.9.0"><meta charset=utf-8><meta name=X-UA-Compatible content="IE=edge"><title>在Android O中获取BuildProperties文件信息 · Hexer</title><meta name=description content="在Android O中获取BuildProperties文件信息 - Hexer"><meta name=viewport content="width=device-width, initial-scale=1"><link rel=icon href=https://i.loli.net/2018/12/05/5c07807cb76f9.png><link rel=stylesheet href=/css/apollo.css><link rel=search type=application/opensearchdescription+xml href=https://imrhj.cn/atom.xml title=Hexer></head><body><div class=wrap><header><a href="/" class=logo-link><img src=https://i.loli.net/2018/12/05/5c07807cb76f9.png alt=logo></a><ul class="nav nav-list"><li class=nav-list-item><a href="/" target=_self class=nav-list-link>BLOG</a></li><li class=nav-list-item><a href="/archives/" target=_self class=nav-list-link>ARCHIVE</a></li><li class=nav-list-item><a href="/about/" target=_self class=nav-list-link>ABOUT</a></li><li class=nav-list-item><a href=https://github.com/ahjsrhj target=_blank class=nav-list-link>GITHUB</a></li><li class=nav-list-item><a href="/friend/" target=_self class=nav-list-link>FRIEND</a></li></ul><script src=/js/canvas-nest-check.js></script></header><main class=container><div class=post><article class=post-block><h1 class=post-title>在Android O中获取BuildProperties文件信息</h1><div class=post-info>2018年5月9日</div><div class=post-content><a id=more></a><h1 id=0x00-起因><a href=#0x00-起因 class=headerlink title="0x00 起因"></a>0x00 起因</h1><p>升级App的 <code>targetSdkVersion</code>至27之后，发现原有的一个获取 Android 系统 <code>BuildProperties</code>信息的类无法正常工作了，初始化时会抛出异常</p><figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br></pre></td><td class=code><pre><span class=line>java.io.FileNotFoundException: /system/build.prop (Permission denied)</span><br><span class=line>        at java.io.FileInputStream.open0(Native Method)</span><br><span class=line>        at java.io.FileInputStream.open(FileInputStream.java:200)</span><br><span class=line>        at java.io.FileInputStream.&lt;init&gt;(FileInputStream.java:150)</span><br><span class=line>        at java.io.FileInputStream.&lt;init&gt;(FileInputStream.java:103)</span><br><span class=line>        at java.io.FileReader.&lt;init&gt;(FileReader.java:58)</span><br></pre></td></tr></table></figure><p>在初始化<code>BuildProperties</code>时，会去读取<code>/system/build.prop</code>的文件信息，相关代码如下:</p><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br></pre></td><td class=code><pre><span class=line></span><br><span class=line><span class=function><span class=keyword>private</span> <span class=title>BuildProperties</span><span class=params>()</span> </span>&#123;</span><br><span class=line>    mProperties = <span class=keyword>new</span> Properties();</span><br><span class=line>    <span class=keyword>try</span> &#123;</span><br><span class=line></span><br><span class=line>        mProperties.load(<span class=keyword>new</span> FileInputStream(<span class=keyword>new</span> File(Environment.getRootDirectory(), <span class=string>"build.prop"</span>)));</span><br><span class=line>    &#125; <span class=keyword>catch</span> (IOException e) &#123;</span><br><span class=line>        e.printStackTrace();</span><br><span class=line>    &#125;</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><p>因为在 Android O 开始，<code>/system/build.prop</code>的读取权限不再对非root用户开放，通过查看文件权限可以确认这个问题</p><ul><li>Android 8.1手机</li></ul><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre></td><td class=code><pre><span class=line><span class=meta>$</span> adb shell ls -l /system/build.prop</span><br><span class=line>-rw-------  1 root root      4699 2009-01-01 08:00 build.prop</span><br></pre></td></tr></table></figure><p>可以看到<code>build.props</code>的文件权限变成了600</p><ul><li>Android 6.0手机</li></ul><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre></td><td class=code><pre><span class=line><span class=meta>$</span> adb shell ls -l /system/build.prop</span><br><span class=line>-rw-r--r-- root     root         9018 2017-12-16 01:51 build.prop</span><br></pre></td></tr></table></figure><p>此时的文件权限是644，非root用户也有读取权限。</p><p>所以这段代码之前可以正常工作，在Android O上就会抛异常。</p><h1 id=0x01-解决方法><a href=#0x01-解决方法 class=headerlink title="0x01 解决方法"></a>0x01 解决方法</h1><h2 id=1-getprop><a href=#1-getprop class=headerlink title="1. getprop"></a>1. getprop</h2><p>通过<code>adb shell</code>命令进入到Android手机的shell环境中，可以执行内置的命令getprop，这条命令返回的是Android property的一个合计，其相关说明为<code>get property via the android property service</code>，这些属性从多个文件中加载，包括<code>/system/build.prop</code>、<code>/default.prop</code>，因此可以在代码中调用这条命令以此获取。</p><p>这样做有两个问题: 1是比直接读取<code>/system/build.prop</code>文件会多几个属性，因为getprop命令里还包含了<code>default.prop</code>文件中的信息，这个问题不大。2是终端输出的信息是形如:</p><figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br></pre></td><td class=code><pre><span class=line>[sys.lineage_settings_system_version]: [3]</span><br><span class=line>[sys.logbootcomplete]: [1]</span><br><span class=line>[sys.oem_unlock_allowed]: [1]</span><br><span class=line>[sys.rescue_boot_count]: [1]</span><br><span class=line>[sys.retaildemo.enabled]: [0]</span><br><span class=line>[sys.sysctl.extra_free_kbytes]: [43200]</span><br></pre></td></tr></table></figure><p>这样的信息，与直接读取文件相比，key 和 value 上被包裹了中括号，因此需要使用正则对结果进行处理之后才能使用。</p><p>相关代码如下:<del>不完整</del></p><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br></pre></td><td class=code><pre><span class=line><span class=function><span class=keyword>public</span> <span class=keyword>static</span> BuildProperties <span class=title>getInstance</span><span class=params>()</span> </span>&#123;</span><br><span class=line>    <span class=keyword>return</span> InstanceHolder.mInstance;</span><br><span class=line>&#125;</span><br><span class=line></span><br><span class=line><span class=keyword>private</span> <span class=keyword>final</span> Properties mProperties;</span><br><span class=line><span class=keyword>private</span> <span class=keyword>final</span> Pattern regex = Pattern.compile(<span class=string>"\\[(.+)]: \\[(.+)]"</span>);</span><br><span class=line><span class=function><span class=keyword>private</span> <span class=title>BuildProperties</span><span class=params>()</span> </span>&#123;</span><br><span class=line>    mProperties = <span class=keyword>new</span> Properties();</span><br><span class=line>    <span class=keyword>try</span> &#123;</span><br><span class=line>        Process p = Runtime.getRuntime().exec(<span class=string>"getprop"</span>);</span><br><span class=line>        BufferedReader in = <span class=keyword>new</span> BufferedReader(<span class=keyword>new</span> InputStreamReader(p.getInputStream()));</span><br><span class=line>        String line;</span><br><span class=line>        <span class=keyword>while</span> ((line = in.readLine()) != <span class=keyword>null</span> &amp;&amp; !line.equals(<span class=string>"null"</span>)) &#123;</span><br><span class=line>            <span class=keyword>this</span>.parseLine(line);</span><br><span class=line>        &#125;</span><br><span class=line>    &#125; <span class=keyword>catch</span> (IOException e) &#123;</span><br><span class=line>        e.printStackTrace();</span><br><span class=line>    &#125;</span><br><span class=line>&#125;</span><br><span class=line><span class=function><span class=keyword>private</span> <span class=keyword>void</span> <span class=title>parseLine</span><span class=params>(String line)</span> </span>&#123;</span><br><span class=line>    <span class=keyword>if</span> (StringUtil.isNotBlank(line)) &#123;</span><br><span class=line>        Matcher m = regex.matcher(line);</span><br><span class=line>        <span class=keyword>if</span> (m.find()) &#123;</span><br><span class=line>            mProperties.setProperty(m.group(<span class=number>1</span>), m.group(<span class=number>2</span>));</span><br><span class=line>        &#125;</span><br><span class=line>    &#125;</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><h2 id=2-通过反射调用-SystemProperties-进行获取><a href=#2-通过反射调用-SystemProperties-进行获取 class=headerlink title="2. 通过反射调用 SystemProperties 进行获取"></a>2. 通过反射调用 SystemProperties 进行获取</h2><p>Android系统源码中大量使用了<code>android.os.SystemProperties</code>进行系统属性的获取与设置，我们可以通过反射来获取这个类进行调用。</p><p>相关代码如下:</p><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br></pre></td><td class=code><pre><span class=line><span class=keyword>public</span> <span class=class><span class=keyword>class</span> <span class=title>SystemProperty</span> </span>&#123;</span><br><span class=line>    <span class=keyword>private</span> <span class=keyword>final</span> Context mContext;</span><br><span class=line></span><br><span class=line>    <span class=function><span class=keyword>public</span> <span class=title>SystemProperty</span><span class=params>(Context mContext)</span> </span>&#123;</span><br><span class=line>        <span class=keyword>this</span>.mContext = mContext;</span><br><span class=line>    &#125;</span><br><span class=line></span><br><span class=line>    <span class=function><span class=keyword>public</span> String <span class=title>getOrThrow</span><span class=params>(String key)</span> <span class=keyword>throws</span> NoSuchPropertyException </span>&#123;</span><br><span class=line>        <span class=keyword>try</span> &#123;</span><br><span class=line>            ClassLoader classLoader = mContext.getClassLoader();</span><br><span class=line>            Class SystemProperties = classLoader.loadClass(<span class=string>"android.os.SystemProperties"</span>);</span><br><span class=line>            Method methodGet = SystemProperties.getMethod(<span class=string>"get"</span>, String<span class=class>.<span class=keyword>class</span>)</span>;</span><br><span class=line>            <span class=keyword>return</span> (String) methodGet.invoke(SystemProperties, key);</span><br><span class=line>        &#125; <span class=keyword>catch</span> (ClassNotFoundException e) &#123;</span><br><span class=line>            <span class=keyword>throw</span> <span class=keyword>new</span> NoSuchPropertyException(e);</span><br><span class=line>        &#125; <span class=keyword>catch</span> (NoSuchMethodException e) &#123;</span><br><span class=line>            <span class=keyword>throw</span> <span class=keyword>new</span> NoSuchPropertyException(e);</span><br><span class=line>        &#125; <span class=keyword>catch</span> (InvocationTargetException e) &#123;</span><br><span class=line>            <span class=keyword>throw</span> <span class=keyword>new</span> NoSuchPropertyException(e);</span><br><span class=line>        &#125; <span class=keyword>catch</span> (IllegalAccessException e) &#123;</span><br><span class=line>            <span class=keyword>throw</span> <span class=keyword>new</span> NoSuchPropertyException(e);</span><br><span class=line>        &#125;</span><br><span class=line>    &#125;</span><br><span class=line></span><br><span class=line>    <span class=function><span class=keyword>public</span> String <span class=title>get</span><span class=params>(String key)</span> </span>&#123;</span><br><span class=line>        <span class=keyword>try</span> &#123;</span><br><span class=line>            <span class=keyword>return</span> getOrThrow(key);</span><br><span class=line>        &#125; <span class=keyword>catch</span> (NoSuchPropertyException e) &#123;</span><br><span class=line>            <span class=keyword>return</span> <span class=keyword>null</span>;</span><br><span class=line>        &#125;</span><br><span class=line>    &#125;</span><br><span class=line></span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><p>代码来自项目<a href=https://github.com/thuxnder/android-getprop target=_blank rel=noopener>android-getprop</a></p></div></article></div></main><footer><div class=paginator><a href="/2018/android-o-broadcast-receiver/" class=prev>PREV</a><a href="/2017/android-textinputlayout-error/" class=next>NEXT</a></div><script>var comments = 'true';
if (comments === 'true') {
    (function() {
        var vl = document.createElement('script');
        vl.src = '//cdn1.lncld.net/static/js/3.0.4/av-min.js';
        vl.async = true;
        (document.getElementsByTagName('head')[0] 
        || document.getElementsByTagName('body')[0]).appendChild(vl);
        var vl2 = document.createElement('script');
        vl2.src = '//unpkg.com/valine/dist/Valine.min.js';
        vl2.async = true;
        (document.getElementsByTagName('head')[0] 
        || document.getElementsByTagName('body')[0]).appendChild(vl2);
        var commitDiv = document.createElement('div');
        commitDiv.id='comment';
        document.getElementsByTagName('footer')[0].appendChild(commitDiv);
    })();
}</script><div class=copyright><p>© 2015 - 2021 <a href=https://imrhj.cn>Hexer</a>, <a href="http://beian.miit.gov.cn/" target=_blank>皖ICP备16006159号-1</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity=sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW crossorigin=anonymous></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-109294877-1",'auto');ga('send','pageview');</script><script>var comments = 'true';
if (comments === 'true') {
    (function() {
        let _tt = 20;
        let _tc = setInterval(() => {
            try {
                new Valine({
                    el: '#comment' ,
                    notify:false, 
                    verify:false, 
                    appId: 'lMIQlAfa6UoprWfiEDOceMSz-gzGzoHsz',
                    appKey: 'KiGYzc5UupBdbac67AJA54dJ',
                    placeholder: '来都来了，说点啥不 ٩(●˙▿˙●)۶…⋆ฺ',
                    path:window.location.pathname, 
                    avatar:'identicon',
                    guest_info: ['nick','link']
                });
                clearInterval(_tc)
            } catch(e) {
                _tt--;
                if (_tt < 1) {
                    clearInterval(_tc)
                }
            }
        }, 500)
    })();
}</script></body></html>