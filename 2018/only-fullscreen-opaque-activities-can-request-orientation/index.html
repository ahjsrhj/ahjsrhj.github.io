<!DOCTYPE html><html lang=zh-CN><head><meta name=generator content="Hexo 3.9.0"><meta charset=utf-8><meta name=X-UA-Compatible content="IE=edge"><title>解决 Only fullscreen opaque activities can request orientation · Hexer</title><meta name=description content="解决 Only fullscreen opaque activities can request orientation - Hexer"><meta name=viewport content="width=device-width, initial-scale=1"><link rel=icon href=https://i.loli.net/2018/12/05/5c07807cb76f9.png><link rel=stylesheet href=/css/apollo.css><link rel=search type=application/opensearchdescription+xml href=https://imrhj.cn/atom.xml title=Hexer></head><body><div class=wrap><header><a href="/" class=logo-link><img src=https://i.loli.net/2018/12/05/5c07807cb76f9.png alt=logo></a><ul class="nav nav-list"><li class=nav-list-item><a href="/" target=_self class=nav-list-link>BLOG</a></li><li class=nav-list-item><a href="/archives/" target=_self class=nav-list-link>ARCHIVE</a></li><li class=nav-list-item><a href="/about/" target=_self class=nav-list-link>ABOUT</a></li><li class=nav-list-item><a href=https://github.com/ahjsrhj target=_blank class=nav-list-link>GITHUB</a></li><li class=nav-list-item><a href="/friend/" target=_self class=nav-list-link>FRIEND</a></li></ul><script src=/js/canvas-nest-check.js></script></header><main class=container><div class=post><article class=post-block><h1 class=post-title>解决 Only fullscreen opaque activities can request orientation</h1><div class=post-info>2018年5月25日</div><div class=post-content><p><img src=https://i.loli.net/2018/05/25/5b0788dd673ed.png alt=1527220441406.png></p><p>这段时间把App的<code>targetSDKVersion</code>升级到了27，昨晚上线之后今早看到后台一堆崩溃，全是 Android 8.0 的设备，因为手头设备有限，测试的时候只测了Android 8.1的设备，没想到还有一个这个坑埋在这里，记录一下处理办法。</p><a id=more></a><h1 id=问题分析><a href=#问题分析 class=headerlink title=问题分析></a>问题分析</h1><p>当<code>targetSDKVersion</code>为26或者27时，在 Android 8.0 的设备上，一些设置了<code>windowIsTranslucent</code>标志，将背景设为透明，同事将屏幕方向锁定的<code>Activity</code>，会崩溃并抛出这个异常:</p><figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br></pre></td><td class=code><pre><span class=line>Caused by: java.lang.IllegalStateException: Only fullscreen opaque activities can request orientation</span><br><span class=line>       at android.app.Activity.onCreate(Activity.java:1007)</span><br><span class=line>       at android.support.v4.app.SupportActivity.onCreate(SupportActivity.java:66)</span><br><span class=line>       at android.support.v4.app.FragmentActivity.onCreate(FragmentActivity.java:321)</span><br><span class=line>       at android.support.v7.app.AppCompatActivity.onCreate(AppCompatActivity.java:84)</span><br><span class=line>       at ...</span><br></pre></td></tr></table></figure><p>这个问题网上有很多讨论以及解决方法，问题的原因出自<a href=https://github.com/aosp-mirror/platform_frameworks_base/commit/39791594560b2326625b663ed6796882900c220f#diff-960c6fdd4a4b336d98b785268b2a78ffR2183 target=_blank rel=noopener>这里</a></p><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre></td><td class=code><pre><span class=line><span class=keyword>if</span> (ActivityInfo.isFixedOrientation(requestedOrientation) &amp;&amp; !fullscreen </span><br><span class=line>	&amp;&amp; appInfo.targetSdkVersion &gt;= O) &#123;</span><br><span class=line>	<span class=keyword>throw</span> <span class=keyword>new</span> IllegalStateException(<span class=string>"Only fullscreen activities can request orientation"</span>);</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><p>这里做了当屏幕方向锁定了并且不为全屏并且 App 的<code>targetSdkVersion</code> 大于 <code>Android O</code>的话，就会抛出这个异常。</p><p>是否为全屏的判定如下:</p><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br></pre></td><td class=code><pre><span class=line><span class=function><span class=keyword>public</span> <span class=keyword>static</span> <span class=keyword>boolean</span> <span class=title>isTranslucentOrFloating</span><span class=params>(TypedArray attributes)</span> </span>&#123;</span><br><span class=line>	<span class=keyword>final</span> <span class=keyword>boolean</span> isTranslucent = attributes.getBoolean(</span><br><span class=line>		com.android.internal.R.styleable.Window_windowIsTranslucent, <span class=keyword>false</span>);</span><br><span class=line>	<span class=keyword>final</span> <span class=keyword>boolean</span> isSwipeToDismiss = </span><br><span class=line>        !attributes.hasValue(com.android.internal.R.styleable.Window_windowIsTranslucent) </span><br><span class=line>		&amp;&amp; attributes.getBoolean(com.android.internal.R.styleable.Window_windowSwipeToDismiss, <span class=keyword>false</span>);</span><br><span class=line>	<span class=keyword>final</span> <span class=keyword>boolean</span> isFloating = </span><br><span class=line>        attributes.getBoolean(com.android.internal.R.styleable.Window_windowIsFloating, <span class=keyword>false</span>);</span><br><span class=line>	<span class=keyword>return</span> isFloating || isTranslucent || isSwipeToDismiss;</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><p>手头的 Android 8.1 的机器并没有触发这个问题，是因为这个问题在 8.1 里已经<a href=https://github.com/aosp-mirror/platform_frameworks_base/commit/a4ceea026d6373e9be4b1daf3aa4ed93de4157cf#diff-960c6fdd4a4b336d98b785268b2a78ffL2197 target=_blank rel=noopener>修复</a>了。</p><p><img src=https://i.loli.net/2018/05/25/5b07ac68bcb4a.png alt=1527229499937.png></p><h1 id=解决方案><a href=#解决方案 class=headerlink title=解决方案></a>解决方案</h1><p>解决方法有如下几种:</p><ol><li><p>降级<code>targetSDKVersion</code>到26以下<del>(废话！！)</del></p></li><li><p>移除<code>mainfest</code>文件里的<code>screenOrientation</code>属性</p></li><li><p>取消Activity主题里的<code>windowIsTranslucent</code>属性或者<code>windowSwipeToDismiss</code>属性或者<code>windowIsFloating</code>属性（根据你设置了什么属性来具体分析）</p></li><li><p>（推荐）移除<code>manifest</code>文件里的<code>screenOrientation</code>属性，并在<code>Activity</code>的<code>onCreate</code>方法里设置屏幕方向</p><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre></td><td class=code><pre><span class=line><span class=keyword>if</span> (Build.VERSION.SDK_INT != Build.VERSION_CODES.O) &#123;</span><br><span class=line>	setRequestedOrientation(ActivityInfo.SCREEN_ORIENTATION_PORTRAIT);</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure></li></ol></div></article></div></main><footer><div class=paginator><a href="/2018/android-o-broadcast-receiver/" class=next>NEXT</a></div><script>var comments = 'true';
if (comments === 'true') {
    (function() {
        var vl = document.createElement('script');
        vl.src = '//cdn1.lncld.net/static/js/3.0.4/av-min.js';
        vl.async = true;
        (document.getElementsByTagName('head')[0] 
        || document.getElementsByTagName('body')[0]).appendChild(vl);
        var vl2 = document.createElement('script');
        vl2.src = '//unpkg.com/valine/dist/Valine.min.js';
        vl2.async = true;
        (document.getElementsByTagName('head')[0] 
        || document.getElementsByTagName('body')[0]).appendChild(vl2);
        var commitDiv = document.createElement('div');
        commitDiv.id='comment';
        document.getElementsByTagName('footer')[0].appendChild(commitDiv);
    })();
}</script><div class=copyright><p>© 2015 - 2021 <a href=https://imrhj.cn>Hexer</a>, <a href="http://beian.miit.gov.cn/" target=_blank>皖ICP备16006159号-1</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity=sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW crossorigin=anonymous></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-109294877-1",'auto');ga('send','pageview');</script><script>var comments = 'true';
if (comments === 'true') {
    (function() {
        let _tt = 20;
        let _tc = setInterval(() => {
            try {
                new Valine({
                    el: '#comment' ,
                    notify:false, 
                    verify:false, 
                    appId: 'lMIQlAfa6UoprWfiEDOceMSz-gzGzoHsz',
                    appKey: 'KiGYzc5UupBdbac67AJA54dJ',
                    placeholder: '来都来了，说点啥不 ٩(●˙▿˙●)۶…⋆ฺ',
                    path:window.location.pathname, 
                    avatar:'identicon',
                    guest_info: ['nick','link']
                });
                clearInterval(_tc)
            } catch(e) {
                _tt--;
                if (_tt < 1) {
                    clearInterval(_tc)
                }
            }
        }, 500)
    })();
}</script></body></html>